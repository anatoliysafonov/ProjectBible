<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Біблія - читати онлайн</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    
    {% load static %}
    <link rel="stylesheet" href="{% static 'bible/style.css' %}">
</head>

<body>
    <nav class="site_navigation">
        {% if not user.is_authenticated %}
        <a href="{% url 'users:login' %}"><button>Увійти</button></a>
        <a href="{% url 'users:signup' %}"><button>Реєстрація</button></a>
        {% endif %}
        {% if user.is_authenticated %}
        <a href="/user/logout"><button>Вийти</button></a>
        {% endif %}
    </nav>
    <header class="page-header">
        <span>{{book_name}}</span>
    </header>

    <nav>
        <a href="/bible/{{book}}/{{prev_page}}"><button class="content_buttoms_button" {% if not prev_page %} disabled {% endif %}>Попередній розділ</button></a>
        <a href="/bible/{{book}}/{{next_page}}"><button class="content_buttoms_button" style="margin-left: 10px;" {% if not next_page %} disabled {% endif %}>Наступний розділ</button></a>
    </nav>

    <main class="outer">
        {% block content %} {% endblock %}
    </main>

    <dialog id="modal">  
            {% csrf_token %}
            <header class="modal_header">
                <span id="modal_verse_text" class="modal_verse_text"></span>
                <i class="material-icons close-button" onclick="hideModal()">close</i>
            </header>
            <textarea rows="25" name="note_text" id="note_text" placeholder="без коментара" class="textNote"></textarea>
            <nav class="dialog_nav">
                <input class="btn-save" type="button" uuid=0 value="Зберегти зміни" id="submit" onclick="customSubmit(this)">
                <input type="button" onclick="undoDeleteText(scope='undo')" value="Відмінити зміни">
                <input class="btn-warning" type="button" onclick="undoDeleteText(scope='delete')" value = "Видалити все">
            </nav>
    </dialog>

<script>
var undoVerseText = null;

$(document).ready(() => {
    objs = document.querySelectorAll(".click_no_propagation");
    objs.forEach(obj => {
        obj.addEventListener("click", (event)=>{
            event.stopPropagation();
        })
    });
})


function openModal(obj, uuid){
    const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    var submit_btn = document.querySelector("#submit");
    var text = document.querySelector("#modal_verse_text");
    var verseText = obj.childNodes[3].childNodes[1].innerHTML;
    // verseText = verseText.replace(/<(a|s|b).{1,25}>/g,'');
    text.innerHTML = verseText;
    submit_btn.setAttribute('uuid', uuid)
    $.ajax({
        type: 'post',
        url: "{% url 'bible:ajaxreadnote' %}",
        data: {csrfmiddlewaretoken: csrf, 'uuid': uuid},
        cache:true,
        success: function(response) {
            var textarea = document.getElementById("note_text");
            textarea.value = response.result;
            undoVerseText = response.result;
            submit_btn.code = response.uuid;
            var modal = document.querySelector("#modal");
            modal.showModal();
            modal.style.display = 'flex';
            textarea.focus();
            textarea.scrollTop = 0;
        }
    })
}

function hideModal(){
    textarea = document.querySelector("#note_text");
    textarea.style.width = '';
    textarea.style.height = '';
    resetModal();
    modal.close();
}

function customSubmit(){
    var text = document.querySelector("#note_text");
    var btn = document.querySelector("#submit");
    var csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    $.ajax({
        type:'post',
        url: "{% url 'bible:ajaxwritenote' %}",
        data: {'text': text.value, 'uuid':btn.getAttribute('uuid'), csrfmiddlewaretoken: csrf},
        success:function(response){
            console.log(response.text);
        }
    });
    hideModal();
}
function undoDeleteText(scope){
    var text = document.querySelector("#note_text");
    if (scope == 'undo'){
        text.value = undoVerseText;
    } else {
        text.value = "";
    }
}

function resetModal() {
    modal = document.querySelector("#modal");
    modal.style.display = "none";
    modal.style.width = '';
    modal.style.height = '';
}
</script>
</body>

</html>